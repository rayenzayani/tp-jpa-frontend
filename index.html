<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestion des Personnes</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --card2:#0f1730; --text:#e8eeff; --muted:#a9b6da;
      --line:rgba(255,255,255,.08); --primary:#7c5cff; --primary2:#4bd4ff;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
                  radial-gradient(1000px 500px at 90% 0%, rgba(75,212,255,.25), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px;margin:32px auto;padding:0 16px}
    .topbar{
      display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:18px;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
    }
    h1{font-size:22px;margin:0}
    .sub{color:var(--muted); font-size:13px; margin-top:2px}
    .pill{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.04); color:var(--muted); font-size:12px;
      display:flex; gap:8px; align-items:center;
    }
    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:16px}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:16px 16px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid var(--line);
    }
    .cardHeader h2{margin:0; font-size:16px}
    .cardHeader .hint{color:var(--muted); font-size:12px; margin-top:3px}
    .cardBody{padding:16px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .field{flex:1; min-width: 190px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select{
      width:100%; padding:11px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(124,92,255,.65); box-shadow:0 0 0 4px rgba(124,92,255,.12)}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0; padding:10px 14px; border-radius:12px; cursor:pointer; color:var(--text);
      background: rgba(255,255,255,.08); border:1px solid var(--line);
      transition:.15s transform, .15s opacity, .15s background;
    }
    button:hover{transform: translateY(-1px); background: rgba(255,255,255,.12)}
    .primary{
      background: linear-gradient(135deg, var(--primary), #9b7bff);
      border:0;
    }
    .danger{background: rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.30)}
    .ghost{background: transparent}
    .mini{padding:7px 10px; border-radius:10px; font-size:12px}
    .split{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .searchWrap{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .tableWrap{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:auto;
      background: rgba(0,0,0,.14);
    }
    table{width:100%; border-collapse: collapse; min-width: 650px}
    th, td{padding:12px 12px; border-bottom: 1px solid var(--line); font-size:13px}
    th{color:var(--muted); text-align:left; font-weight:600; background: rgba(255,255,255,.03)}
    tr:hover td{background: rgba(255,255,255,.03)}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background: rgba(255,255,255,.04);
      color:var(--muted);
    }
    .badge.ok{color: #b7ffd2; border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .badge.warn{color: #ffe2b1; border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12)}
    .badge.bad{color: #ffd0d0; border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}
    .right{display:flex; gap:8px; justify-content:flex-end}
    .kpi{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    }
    .kpi .box{
      padding:12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .kpi .n{font-size:18px; font-weight:700}
    .kpi .t{font-size:12px; color:var(--muted)}
    .footerNote{margin-top:10px; color:var(--muted); font-size:12px}

    /* Toast */
    .toasts{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:9999}
    .toast{
      width: 340px; max-width: calc(100vw - 32px);
      padding:12px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(16,26,51,.92); box-shadow: var(--shadow);
      display:flex; gap:10px; align-items:flex-start;
      animation: pop .18s ease-out;
    }
    .dot{width:10px;height:10px;border-radius:999px;margin-top:5px}
    .toast.ok .dot{background: var(--ok)}
    .toast.err .dot{background: var(--bad)}
    .toast.warn .dot{background: var(--warn)}
    .toast .title{font-weight:700; font-size:13px}
    .toast .text{color:var(--muted); font-size:12px; margin-top:2px}
    @keyframes pop{ from{transform:translateY(6px); opacity:.3} to{transform:translateY(0); opacity:1} }

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center;
      z-index:9998; padding: 16px;
    }
    .modal{
      width: 620px; max-width: 100%;
      border-radius: 18px; border:1px solid var(--line); background: var(--card);
      box-shadow: var(--shadow); overflow:hidden;
    }
    .modalHead{
      padding:14px 16px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.20);
    }
    .modalHead h3{margin:0; font-size:15px}
    .close{background:transparent}
    .modalBody{padding:16px}
    .modalFoot{padding:14px 16px; border-top:1px solid var(--line); display:flex; gap:10px; justify-content:flex-end}
  </style>
</head>
<body>
  <div class="container">

    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Gestion des Personnes</h1>
          <div class="sub">Frontend HTML + JS ‚Äî Consommation API JAX-RS (Tomcat)</div>
        </div>
      </div>
      <div class="pill">
        <span>API</span>
        <code id="apiPill"></code>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Table -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Liste des personnes</h2>
            <div class="hint">Recherche, tri, √©dition, suppression ‚Äî mise √† jour dynamique</div>
          </div>
          <button class="mini" onclick="loadAll()">üîÑ Rafra√Æchir</button>
        </div>
        <div class="cardBody">

          <div class="split">
            <div class="searchWrap">
              <div class="field" style="min-width:260px">
                <label>Recherche (par Name)</label>
                <input id="q" type="text" placeholder="ex: Ahmed" oninput="applyFilter()">
              </div>
              <div class="field" style="min-width:180px">
                <label>Trier</label>
                <select id="sort" onchange="applyFilter()">
                  <option value="id_asc">ID ‚Üë</option>
                  <option value="id_desc">ID ‚Üì</option>
                  <option value="age_asc">Age ‚Üë</option>
                  <option value="age_desc">Age ‚Üì</option>
                  <option value="name_asc">Name A‚ÜíZ</option>
                  <option value="name_desc">Name Z‚ÜíA</option>
                </select>
              </div>
            </div>

            <div class="kpi" style="min-width:320px">
              <div class="box">
                <div class="n" id="kTotal">0</div>
                <div class="t">Total</div>
              </div>
              <div class="box">
                <div class="n" id="kAvg">0</div>
                <div class="t">√Çge moyen</div>
              </div>
              <div class="box">
                <div class="n" id="kMax">0</div>
                <div class="t">√Çge max</div>
              </div>
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th>Name</th>
                  <th style="width:120px">Age</th>
                  <th style="width:220px; text-align:right">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="4" style="color:var(--muted)">Chargement...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="footerNote">
            Astuce: clique sur ‚úèÔ∏è pour √©diter via modal, ou üóëÔ∏è pour supprimer.
          </div>

        </div>
      </div>

      <!-- Right: Forms -->
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Cr√©er une personne</h2>
            <div class="hint">POST /add ‚Äî validation c√¥t√© client</div>
          </div>
          <span class="badge" id="statusBadge">‚óè pr√™t</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field">
              <label>Name *</label>
              <input id="name" type="text" placeholder="ex: Amal">
            </div>
            <div class="field">
              <label>Age *</label>
              <input id="age" type="number" min="0" max="130" placeholder="ex: 22">
            </div>
          </div>
          <div class="btns">
            <button class="primary" onclick="addPerson()">‚ûï Ajouter</button>
            <button class="ghost" onclick="resetCreate()">‚ôªÔ∏è Reset</button>
            <button onclick="seedDemo()">‚ú® Demo (ajout rapide)</button>
          </div>

          <hr style="border:0;border-top:1px solid var(--line); margin:16px 0">

          <h2 style="font-size:16px;margin:0 0 6px">Recherche par ID</h2>
          <div class="hint" style="margin-bottom:10px">GET /{id}</div>

          <div class="row">
            <div class="field" style="min-width:160px">
              <label>ID</label>
              <input id="searchId" type="number" placeholder="ex: 1">
            </div>
            <div class="btns" style="margin-top: 18px">
              <button onclick="getById()">üîé Chercher</button>
            </div>
          </div>
          <div class="card" style="margin-top:12px; background:rgba(0,0,0,.18); border-radius:14px; box-shadow:none">
            <div class="cardBody" style="padding:12px">
              <div class="hint">R√©sultat</div>
              <pre id="one" style="margin:6px 0 0; color:var(--muted); white-space:pre-wrap">‚Äî</pre>
            </div>
          </div>

          <div class="footerNote">
            Si l‚ÄôAPI est sur un autre port, change <b>API_BASE</b> en bas du fichier.
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal Edit -->
  <div class="modalBack" id="modalBack" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3>Modifier une personne</h3>
        <button class="close mini" onclick="closeModal()">‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>ID</label>
            <input id="m_id" type="number" disabled>
          </div>
          <div class="field">
            <label>Name *</label>
            <input id="m_name" type="text">
          </div>
          <div class="field">
            <label>Age *</label>
            <input id="m_age" type="number" min="0" max="130">
          </div>
        </div>
        <div class="footerNote" style="margin-top:10px">
          PUT /update ‚Äî envoie un JSON: { "id":..., "name":..., "age":... }
        </div>
      </div>
      <div class="modalFoot">
        <button class="ghost" onclick="closeModal()">Annuler</button>
        <button class="primary" onclick="updatePerson()">üíæ Enregistrer</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toasts" id="toasts"></div>

<script>
  // ‚úÖ adapte uniquement si ton port / context change
  const API_BASE = "http://localhost:8088/tp_jpa/api/persons";
  document.getElementById("apiPill").textContent = API_BASE;

  let persons = [];
  let filtered = [];

  function toast(type, title, text){
    const wrap = document.getElementById("toasts");
    const el = document.createElement("div");
    el.className = `toast ${type}`;
    el.innerHTML = `
      <div class="dot"></div>
      <div>
        <div class="title">${title}</div>
        <div class="text">${text}</div>
      </div>
    `;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity = "0"; el.style.transform="translateY(6px)"; }, 3200);
    setTimeout(()=>{ el.remove(); }, 3600);
  }

  function setBadge(kind, text){
    const b = document.getElementById("statusBadge");
    b.className = `badge ${kind || ""}`;
    b.textContent = `‚óè ${text}`;
  }

  function validateNameAge(name, age){
    if(!name || name.trim().length < 2) return "Name Ÿäÿ¨ÿ® ŸäŸÉŸàŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ÿ≠ÿ±ŸÅŸäŸÜ";
    const n = Number(age);
    if(!Number.isFinite(n) || n < 0 || n > 130) return "Age ŸÑÿßÿ≤ŸÖ ŸäŸÉŸàŸÜ ÿ±ŸÇŸÖ ÿ®ŸäŸÜ 0 Ÿà 130";
    return null;
  }

  function computeKpi(list){
    const total = list.length;
    const ages = list.map(x => Number(x.age)).filter(n => Number.isFinite(n));
    const avg = total ? Math.round((ages.reduce((a,b)=>a+b,0) / ages.length) * 10)/10 : 0;
    const max = ages.length ? Math.max(...ages) : 0;
    document.getElementById("kTotal").textContent = total;
    document.getElementById("kAvg").textContent = avg;
    document.getElementById("kMax").textContent = max;
  }

  function ageBadge(age){
    const n = Number(age);
    if(!Number.isFinite(n)) return `<span class="badge">‚Äî</span>`;
    if(n < 18) return `<span class="badge warn">Mineur</span>`;
    if(n <= 60) return `<span class="badge ok">Adulte</span>`;
    return `<span class="badge bad">Senior</span>`;
  }

  function renderTable(list){
    const tbody = document.getElementById("tbody");
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="4" style="color:var(--muted)">Aucune personne (liste vide)</td></tr>`;
      computeKpi(list);
      return;
    }
    tbody.innerHTML = "";
    list.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id ?? ""}</td>
        <td>
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
            <div>
              <div style="font-weight:700">${escapeHtml(p.name ?? "")}</div>
              <div class="hint">id=${p.id} ‚Ä¢ ${ageBadge(p.age)}</div>
            </div>
          </div>
        </td>
        <td>${p.age ?? ""}</td>
        <td class="right">
          <button class="mini" onclick='openEdit(${JSON.stringify(p)})'>‚úèÔ∏è Modifier</button>
          <button class="mini danger" onclick="deletePerson(${p.id})">üóëÔ∏è Supprimer</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    computeKpi(list);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function applyFilter(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    const sort = document.getElementById("sort").value;

    filtered = persons.filter(p => {
      const name = (p.name || "").toLowerCase();
      return !q || name.includes(q);
    });

    const getName = (p) => (p.name || "").toLowerCase();
    const getAge = (p) => Number(p.age) || 0;
    const getId  = (p) => Number(p.id) || 0;

    const cmp = {
      id_asc:   (a,b)=>getId(a)-getId(b),
      id_desc:  (a,b)=>getId(b)-getId(a),
      age_asc:  (a,b)=>getAge(a)-getAge(b),
      age_desc: (a,b)=>getAge(b)-getAge(a),
      name_asc: (a,b)=>getName(a).localeCompare(getName(b)),
      name_desc:(a,b)=>getName(b).localeCompare(getName(a)),
    }[sort];

    filtered.sort(cmp);
    renderTable(filtered);
  }

  async function loadAll(){
    try{
      setBadge("", "chargement...");
      const res = await fetch(`${API_BASE}/all`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      persons = await res.json();
      if(!Array.isArray(persons)) persons = [];
      applyFilter();
      setBadge("ok", "connect√©");
      toast("ok", "Chargement", "Liste des personnes mise √† jour.");
    }catch(e){
      setBadge("bad", "erreur API");
      toast("err", "Erreur", "Impossible de charger /all : " + e.message);
      renderTable([]);
    }
  }

  function resetCreate(){
    document.getElementById("name").value = "";
    document.getElementById("age").value = "";
    toast("warn", "Reset", "Formulaire r√©initialis√©.");
  }

  async function addPerson(){
    try{
      const name = document.getElementById("name").value;
      const age  = document.getElementById("age").value;

      const err = validateNameAge(name, age);
      if(err){ toast("warn", "Validation", err); return; }

      const payload = { name: name.trim(), age: Number(age) };

      const res = await fetch(`${API_BASE}/add`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const ok = await res.json(); // ton API retourne boolean
      if(ok){
        toast("ok", "Ajout", `Person ajout√©e: ${payload.name} (${payload.age})`);
        resetCreate();
        await loadAll();
      }else{
        toast("err", "Ajout", "Le backend a retourn√© false.");
      }
    }catch(e){
      toast("err", "Erreur", "addPerson: " + e.message);
    }
  }

  async function deletePerson(id){
    if(!confirm(`Supprimer la personne ID=${id} ?`)) return;
    try{
      const res = await fetch(`${API_BASE}/delete/${id}`, { method:"DELETE" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const ok = await res.json();
      if(ok){
        toast("ok", "Suppression", `Person ID=${id} supprim√©e.`);
        await loadAll();
      }else{
        toast("err", "Suppression", "Le backend a retourn√© false.");
      }
    }catch(e){
      toast("err", "Erreur", "deletePerson: " + e.message);
    }
  }

  async function getById(){
    const id = Number(document.getElementById("searchId").value);
    if(!id){ toast("warn", "Validation", "Donne un ID."); return; }
    try{
      const res = await fetch(`${API_BASE}/${id}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      document.getElementById("one").textContent = JSON.stringify(data, null, 2);
      toast("ok", "Recherche", `R√©sultat re√ßu pour ID=${id}.`);
    }catch(e){
      document.getElementById("one").textContent = "‚Äî";
      toast("err", "Erreur", "getById: " + e.message);
    }
  }

  // Modal edit
  function openEdit(p){
    document.getElementById("m_id").value = p.id ?? "";
    document.getElementById("m_name").value = p.name ?? "";
    document.getElementById("m_age").value = p.age ?? "";
    document.getElementById("modalBack").style.display = "flex";
  }
  function closeModal(){
    document.getElementById("modalBack").style.display = "none";
  }

  async function updatePerson(){
    try{
      const id = Number(document.getElementById("m_id").value);
      const name = document.getElementById("m_name").value;
      const age = document.getElementById("m_age").value;

      const err = validateNameAge(name, age);
      if(err){ toast("warn", "Validation", err); return; }

      const payload = { id, name: name.trim(), age: Number(age) };

      const res = await fetch(`${API_BASE}/update`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const ok = await res.json();
      if(ok){
        toast("ok", "Modification", `Person ID=${id} mise √† jour.`);
        closeModal();
        await loadAll();
      }else{
        toast("err", "Modification", "Le backend a retourn√© false.");
      }
    }catch(e){
      toast("err", "Erreur", "updatePerson: " + e.message);
    }
  }

  function seedDemo(){
    const samples = [
      {name:"Ahmed", age:21},
      {name:"Ines", age:19},
      {name:"Sami", age:34},
      {name:"Meriem", age:27},
      {name:"Youssef", age:16},
      {name:"Khaled", age:61},
    ];
    const pick = samples[Math.floor(Math.random()*samples.length)];
    document.getElementById("name").value = pick.name;
    document.getElementById("age").value = pick.age;
    toast("warn", "Demo", "Champs remplis (ajout rapide).");
  }

  // Auto load at start
  loadAll();
</script>
</body>
</html>
